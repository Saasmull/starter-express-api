<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uploads</title>
    <style>
        *{
            box-sizing: border-box;
            font-family: sans-serif;
        }
        html,body{
            width: 100%;
            height: 100%;
            margin: 0;
        }
        #path{
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
        }
        #path>.path-input-wrapper{
            display: inline-flex;
            flex-direction: row;
            flex-wrap: nowrap;
        }
        #files{
            display: flex;
            flex-wrap: wrap;
        }
        #files>.f-wrapper{
            width: 84px;
            height: 104px;
            margin: 5px;
            text-align: center;
        }
        #files>.f-wrapper.f-selected{
            background-color: grey;
        }
        #files>.f-wrapper *{
            pointer-events: none;
        }
        #files>.f-wrapper>div{
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #files>.f-wrapper>.f-name{
            width: 100%;
            word-wrap: break-word;
            /*white-space: pre-line;*/
            overflow-wrap: break-word;
            display: inline-block;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #files>.f-wrapper>.file-icon>svg{
            transform: translateX(2.5px);
        }
        #files>.f-wrapper>.file-icon>span{
            text-transform: uppercase;
            background-color: red;
            color: whitesmoke;
            position: absolute;
            /*transform: translate(calc(-30px - 50%),21px);*/
            transform: translate(-2.5px,5px);
            font-size: 11px !important;
            font-family: sans-serif !important;
            padding: 1px !important;
            width: 32px;
            text-align: center;
            user-select: none;
            -webkit-user-drag: none;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <div id="options">
            <button class="new-options"><img alt="Add icon" src="static/icons/add-circle.svg">New</button>
            <button id="up-button"><img alt="Upload icon" src="static/icons/upload.svg"></button>
            <button id="del-button"><img alt="Delete icon" src="static/icons/delete.svg"></button>
        </div>
        <div id="path">
            <button><img alt="Go up icon" src="static/icons/arrow-upward.svg"></button>
            <div class="path-input-wrapper">
                <input id="path-input" type="url" aria-label="Path" value="/" autocapitalize="off" autocomplete="off">
                <div class="path-visual">
                    /
                </div>
                <button onclick="viewFolder()"><img alt="Refesh icon" src="static/icons/refresh.svg"></button>
            </div>
        </div>
    </div>
    <div id="explorer">
        <div></div>
        <div id="files">
            <% for(var i in fileUploads.childs){ %>
                <div class="f-wrapper">
                    <% if(fileUploads.childs[i].type === "file"){ %>
                    <div class="file-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="0,0,256,256">
                            <g transform="scale(5.33333,5.33333)">
                                <path d="M39,16v25c0,1.105 -0.895,2 -2,2h-26c-1.105,0 -2,-0.895 -2,-2v-34c0,-1.105 0.895,-2 2,-2h17z" fill="#cccccc"></path>
                                <path d="M28,5v9c0,1.105 0.895,2 2,2h9z" fill="#777777"></path>
                            </g>
                        </svg>
                        <span<%- (i.includes(".")?"":" style='display:none;'") %>><%= i.split('.').pop() %></span>
                    </div>
                    <% }else{ %>
                    <div class="folder-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="0 0 48 48">
                            <path fill="#FFA000" d="M40,12H22l-4-4H8c-2.2,0-4,1.8-4,4v8h40v-4C44,13.8,42.2,12,40,12z"></path>
                            <path fill="#FFCA28" d="M40,12H8c-2.2,0-4,1.8-4,4v20c0,2.2,1.8,4,4,4h32c2.2,0,4-1.8,4-4V16C44,13.8,42.2,12,40,12z"></path>
                        </svg>
                    </div>
                    <% } %>
                    <span class="f-name"><%= i %></span>
                </div>
            <% } %>
        </div>
    </div>
    
    <!--div>
        <input hidden type="file">
        <button id="old-up-button">Upload</button>
    </!--div>
    <div-->
        <!--button id="old-del-button">Delete</!--button>
    </div-->
    
    <%# JSON.stringify(fileUploads) %>
    <%- include("scripts/dropdown") %>
    <%- include("scripts/dialog") %>
    <script>
        function renderVisualPath(){
            var visualPath = document.querySelector(".path-visual");
            var path = getCurrentPath()||"/";
            if(!path.startsWith("/")){
                path = "/" + path;
            }
            path = path.split("/").splice(1);
            console.log(path);
            visualPath.innerHTML = '<button><img alt="Folder icon" src="static/icons/folder.svg">Root</button>';
            var cleanPath = "/";
            if(!currentFS.root){
                for(var i of path){
                    cleanPath += i + "/";
                    visualPath.innerHTML += '<img alt="Chevron right icon" src="static/icons/chevron-right.svg">';
                    var folderButton = document.createElement("button");
                    folderButton.innerText = i;
                    visualPath.appendChild(folderButton);
                }
                while(cleanPath.endsWith("/")){
                    cleanPath = cleanPath.substring(0,cleanPath.length-1);
                }
                console.log(cleanPath.substring(0,cleanPath.length-1),cleanPath.substr(0,-1),cleanPath);
            }
            document.querySelector("#path-input").value = cleanPath;
        }
        //setInterval(renderVisualPath,2000);
        
        var path = "";
        var currentFS = {};
        function viewFolder(){
            var url = new URL(location.href.replace(/upload[/]?$/,"file-upload"));
            url.search = new URLSearchParams({
                CurrentPath:getCurrentPath()
            }).toString();
            var xhr = new XMLHttpRequest();
            xhr.addEventListener("load",function () {
                console.log(this);
                currentFS = JSON.parse(this.responseText);
                var filesElement = document.querySelector("#files")
                filesElement.innerHTML = "";
                for(var i in currentFS.childs){
                    var fWrapper = document.createElement("div");
                    fWrapper.classList.add("f-wrapper");
                    fWrapper.innerHTML = ((currentFS.childs[i].type === "file")?`
                    <div class="file-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="0,0,256,256">
                            <g transform="scale(5.33333,5.33333)">
                                <path d="M39,16v25c0,1.105 -0.895,2 -2,2h-26c-1.105,0 -2,-0.895 -2,-2v-34c0,-1.105 0.895,-2 2,-2h17z" fill="#cccccc"></path>
                                <path d="M28,5v9c0,1.105 0.895,2 2,2h9z" fill="#777777"></path>
                            </g>
                        </svg>
                        <span></span>
                    </div>
                    `:`
                    <div class="folder-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48" viewBox="0 0 48 48">
                            <path fill="#FFA000" d="M40,12H22l-4-4H8c-2.2,0-4,1.8-4,4v8h40v-4C44,13.8,42.2,12,40,12z"></path>
                            <path fill="#FFCA28" d="M40,12H8c-2.2,0-4,1.8-4,4v20c0,2.2,1.8,4,4,4h32c2.2,0,4-1.8,4-4V16C44,13.8,42.2,12,40,12z"></path>
                        </svg>
                    </div>
                    `)+'<span class="f-name"></span>';
                    if(currentFS.childs[i].type === "file"){
                        if(i.includes(".")){
                            fWrapper.querySelector("span").innerText = i.split(".").pop();
                        }else{
                            fWrapper.querySelector("span").style.display = "none";
                        }
                    }
                    fWrapper.querySelector(".f-name").innerText = i;
                    filesElement.appendChild(fWrapper);
                }
                init();
                renderVisualPath();
            });
            xhr.open("GET", url);
            xhr.send();
        }
        function getCurrentPath(){
            return document.querySelector("#path-input").value.replaceAll(/\/{2,}/g,"/").replace(/\/$/,"");
        }
        /*setInterval(async function(){
            var url = new URL(location.href.replace(/upload[/]?$/,"file-upload"));
            url.search = new URLSearchParams({
                CurrentPath:getCurrentPath()
            }).toString();
            function reqListener() {
                console.log(this);
                currentFS = JSON.parse(this.responseText);
            }

            var xhr = new XMLHttpRequest();
            xhr.addEventListener("load", reqListener);
            //console.log("XHR",xhr);
            xhr.open("GET", url);
            xhr.send();
        },7000);*/
        console.log(window);
        window.parent.onmessage = function(e){
            if(e.data === "get selected"){
                var sel = document.querySelector(".f-selected .f-name");
                if(sel){
                    console.log(sel,top,parent);
                    e.source.postMessage(path+sel.innerHTML);
                }
                console.log(e);
            }
        }
        var createDialog = new DialogWindow("Create folder",[
            {
                name:"Create",
                level:"ok",
                onClicked:function(e,dia){
                    var input = dia.element.querySelector("input");
                    if(input){
                        var formData = new FormData();
                        if(input.id === "new-folder-name"){
                            formData.append("CreateFolder",input.value);
                        }else{
                            formData.append("CreateFile",input.value);
                        }
                        console.log("PATH",getCurrentPath());
                        formData.append("CurrentPath",getCurrentPath()+"/");
                        var xhr = new XMLHttpRequest();
                        xhr.open("POST","/file-upload");
                        xhr.addEventListener("load",viewFolder);
                        xhr.send(formData);
                    }
                    dia.hide();
                }
            }
        ],"");
        var newOptions = new Dropdown(document.querySelector(".new-options"),[
            {
                content:"Folder",
                onClicked:function(e,drop){
                    drop.hide();
                    createDialog.setTitle("Create new folder");
                    createDialog.setContent(`
                    <label for="new-folder-name">Folder name</label><input id="new-folder-name" value="New Folder">
                    `);
                    createDialog.show();
                    createDialog.element.querySelector("input").select();
                }
            },
            {
                content:"Text file",
                onClicked:function(e,drop){
                    drop.hide();
                    createDialog.setTitle("Create new file");
                    createDialog.setContent(`
                    <label for="new-file-name">File name</label><input id="new-file-name" value="New file.txt">
                    `);
                    createDialog.show();
                    createDialog.element.querySelector("input").select();
                }
            }
        ])
        var deleteFile = new DialogWindow("Delete file",[
            {
                name:"Delete",
                level:"danger",
                onClicked:function(e,dia){
                    /*var input = dia.element.querySelector("input[type=file]");
                    if(input.files.length === 1){
                        var formData = new FormData();
                        formData.append("Upload",input.files[0]);
                        var xhr = new XMLHttpRequest();
                        xhr.open("POST","/file-upload");
                        xhr.upload.onprogress = function(e){
                            //console.log(e);
                            console.log(Math.floor((e.loaded/e.total)*100)+"%");
                        }
                        xhr.send(formData);
                    }
                    console.log(e);*/
                    var toDelete = dia.element.querySelector(".dialog-content>span").innerHTML;
                    var formData = new FormData();
                    formData.append("Delete",toDelete);
                    formData.append("CurrentPath",getCurrentPath()+"/");
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST","/file-upload");
                        xhr.addEventListener("load",viewFolder);
                    xhr.send(formData);
                    dia.hide();
                }
            }
        ],"Do you want to delete<span></span>?");
        var selectFileUpload = new DialogWindow("Upload file",[
            {
                name:"Upload",
                level:"ok",
                onClicked:function(e,dia){
                    var input = dia.element.querySelector("input[type=file]");
                    if(input.files.length === 1){
                        var formData = new FormData();
                        formData.append("Upload",input.files[0]);
                        formData.append("CurrentPath",getCurrentPath()+"/");
                        var xhr = new XMLHttpRequest();
                        xhr.open("POST","/file-upload");
                        xhr.upload.onprogress = function(e){
                            //console.log(e);
                            var perc = Math.floor((e.loaded/e.total)*100)+"%";
                            console.log(perc);
                            if(perc === "100%"){
                                viewFolder();
                            }
                        }
                        xhr.send(formData);
                    }
                    console.log(e);
                    dia.hide();
                }
            }
        ],"<input aria-label='Upload file' type=file>");
        //selectFileUpload.show();
        var upButton = document.querySelector("#up-button");
        upButton.addEventListener("click",function(e){
            /*if(upButton.previousElementSibling.files.length === 1){
                var formData = new FormData();
                formData.append("Upload",upButton.previousElementSibling.files[0]);
                var xhr = new XMLHttpRequest();
                xhr.open("POST","/file-upload");
                xhr.upload.onprogress = function(e){
                    //console.log(e);
                    console.log(Math.floor((e.loaded/e.total)*100)+"%");
                }
                xhr.send(formData);
            }
            console.log(upButton.previousElementSibling.files);*/
            selectFileUpload.show();
        });
        var delButton = document.querySelector("#del-button");
        delButton.addEventListener("click",function(e){
            var toDelete = document.querySelector(".f-selected");
            if(!!toDelete){
                toDelete = toDelete.querySelector(".f-name").innerText;
            }else{
                return false;
            }
            var div = document.createElement("div");
            div.innerText = toDelete;
            deleteFile.setContent("Do you want to delete \"<span>" + div.innerHTML + "</span>\"?");
            deleteFile.show();
            /*if(confirm("Do you want to delete the file "+toDelete+"?")){
                if(upButton.previousElementSibling.files.length === 1){
                    var formData = new FormData();
                    formData.append("Delete",toDelete);
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST","/file-upload");
                    xhr.onreadystatechange = function(e){
                        //console.log(e);
                    }
                    xhr.send(formData);
                }
            }*/
        });

        function init(){
            document.querySelectorAll(".f-wrapper").forEach(function(el){
                el.addEventListener("click",function(e){
                    console.log(e);
                    if(!e.ctrlKey){
                        document.querySelectorAll(".f-selected").forEach(function(el){
                            el.classList.remove("f-selected");
                        });
                    }
                    e.target.classList.toggle("f-selected");
                });
                el.addEventListener("dblclick",function(e){
                    if(e.target.children[0].classList.contains("folder-icon")){
                        document.querySelector("#path-input").value += "/" + e.target.children[1].innerText;
                        viewFolder();
                    }
                })
            })
        }
        init();

        /*var pathInputDebounce;
        document.querySelector("#path-input").addEventListener("input",function(){
            setTimeout(function(){
                viewFolder();
            },500);
        })*/
        document.querySelector("#path-input").addEventListener("blur",function(e){
            console.log("BLUR event",e);
            viewFolder();
        })
    </script>
</body>
</html>